{% extends 'base.html' %}
{% load form_extras %}


{% block title %}
Item
{% endblock title %}

{% block content %}

<main class=" min-h-screen flex flex-col  gap-5 p-6 w-full mt-17" id="main">
    <h1 class="text-3xl font-bold mb-4">Add Items</h1>
    <div class="flex  gap-12">
        <form id="add-item-form" action="" method="post" class="flex-grow max-w-[500px]">
            {% csrf_token %}
            <fieldset class="fieldset mb-1">
                <label class="label text-xl" for="{{ form.name.id_for_label }}">{{form.name.label}}</label>
                {{ form.name|add_class:"input p-3 mb-1 min-w-[300px] w-full" }}

                <ul>
                    {% for error in form.name.errors %}
                    <li class="text-red-500 text-sm">{{ error }}</li>
                    {% endfor %}
                </ul>

            </fieldset>
            <button type="submit" class="btn btn-primary">Add Item</button>
        
        </form>
         <div class="flex-grow">
            <h1 class="text-2xl font-bold mb-4">Grades List</h1>
            <div class="overflow-x-auto rounded-box border border-base-content/5 bg-base-100">
                <table class="table">
                    <!-- head -->
                    <thead>
                        <tr>
                            <th>SN</th>
                            <th>Item Name</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="item-list">

                        {% for item in item_list %}
                        <!-- row -->
                        <tr id="item-{{ item.id }}">
                            <th>{{ forloop.counter }}</th>
                            <td>{{ item.name }}</td>
                            <td>
                                <div class="flex gap-2">
                                    <button class="btn btn-sm btn-primary">Update</button>
                                    <button data-item-id="{{ item.id }}" 
                                    class="btn btn-sm btn-error" 
                                    onclick="delete_item(this)">Delete</button>
                                </div>
                            </td>

                        </tr>

                        {% endfor %}

                    </tbody>
                </table>
            </div>

        </div>
    </div>
</main>

<script>

    function remove_item_from_table(item_id) {
        const row_id_to_be_deleted=`item-${item_id}`
        const row_to_be_deleted = document.getElementById(row_id_to_be_deleted)
        row_to_be_deleted.remove()

    }

    function delete_item(btnElement) {
        const item_id = btnElement.dataset.itemId;

        fetch("{% url 'shop:item_list_delete' 'dummy' %}".replace('dummy',item_id))
            .then((response) => response.json())
            .then((data) => {
                if (data.success) {
                    show_toast_message(data.message,success=true)
                    remove_item_from_table(item_id)
                } else {
                     show_toast_message("Error: " + data.message,success=false)
                }
            })
            .catch((err) => console.error(err));
    }

    function show_toast_message(message,success=true) {
        const mainDiv=document.getElementById("main")
        const toastDiv = document.getElementById("toast-message")

        toastDiv?.remove()

        mainDiv.insertAdjacentHTML(
            "afterbegin",`
            <div class="toast toast-end toast-top z-50" id="toast-message">
                <div class="alert alert-${success===true?'success':'error'} shadow-lg">
                    <span class="font-semibold">${message}</span>
                </div>
            </div>
            `
        )
    }

    function add_item_to_table(item) {
        const table_body = document.getElementById("item-list");
        const rows_count=table_body.children.length
        const table_row = document.createElement("tr");
        table_row.id = `item-${item.id}`

        table_row.innerHTML = `
            <th>${rows_count+1}</th>
            <td>${item.name}</td>
            <td>
                <div class="flex gap-2">
                    <button class="btn btn-sm btn-primary">Update</button>
                    <button data-item-id="${{ item.id }}" 
                    class="btn btn-sm btn-error" 
                    onclick="delete_item(this)">Delete</button>
                </div>
            </td>
        `
        table_body.appendChild(table_row)
    }

    document
        .getElementById("add-item-form")
        .addEventListener("submit", function (e) {
            e.preventDefault(); // Prevent the form from submitting normally, which would cause a page reload

            const formData = new FormData(this); // this means, current target html element,which is in this case is our add-item-form

            const csrf_token = document.getElementsByName("csrfmiddlewaretoken")[0].value;
            
            
            fetch("{% url 'shop:item_list' %}", {
                method: "POST",
                headers: { "X-CSRFToken": csrf_token },
                body: formData,
            })
                .then((response) => response.json())
                .then((data) => {
                    if (data.success) {
                        show_toast_message(data.message,success=true)
                        add_item_to_table(data.data);
                    } else {
                        show_toast_message("Error: " + data.message,success=false)
                    }
                })
                .catch((err) => console.error(err));
        });

</script>

{% endblock content %}