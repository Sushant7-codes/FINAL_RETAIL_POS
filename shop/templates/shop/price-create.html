{% extends 'base.html' %}
{% load form_extras %}


{% block title %}
Price
{% endblock title %}

{% block content %}

<main class="min-h-screen flex flex-col gap-5 p-4 md:p-6 w-full mt-17" id="main">

    <div class="toast toast-end toast-top">
    {% for message in messages %}
    {% if message.level == DEFAULT_MESSAGE_LEVELS.ERROR %}
    <div class="alert alert-error alert-soft">
        {% else %}
        <div class="alert alert-success alert-soft">
            {% endif %}
            <span>{{message}}</span>
        </div>
        {% endfor %}
    </div>
    
    <h1 class="text-2xl md:text-3xl font-bold mb-4">Add Item ({{item.name}})</h1>
    
    <div class="flex flex-col lg:flex-row gap-6 lg:gap-8">
        <!-- Form Section -->
        <div class="w-full lg:max-w-[500px]">
            <form id="add-price-form" action="" method="post" class="card bg-base-100 shadow-xl p-6">
                {% csrf_token %}
                <input type="hidden" name="item_id" value="{{item.id}}">
                
                <fieldset class="fieldset mb-4">
                    <label class="label text-lg font-semibold" for="{{ form.name.id_for_label }}">Item {{form.name.label}}</label>
                    {{ form.name|add_class:"input input-bordered w-full" }}

                    <ul>
                        {% for error in form.name.errors %}
                        <li class="text-red-500 text-sm">{{ error }}</li>
                        {% endfor %}
                    </ul>
                </fieldset>

                <fieldset class="fieldset mb-4">
                    <label class="label text-lg font-semibold" for="{{ form.amount.id_for_label }}">{{form.amount.label}} (Nrs)</label>
                    {{ form.amount|add_class:"input input-bordered w-full" }}

                    <ul>
                        {% for error in form.amount.errors %}
                        <li class="text-red-500 text-sm">{{ error }}</li>
                        {% endfor %}
                    </ul>
                </fieldset> 

                <fieldset class="fieldset mb-6">
                    <label class="label text-lg font-semibold" for="{{ form.stock.id_for_label }}">{{ form.stock.label }}</label>
                    {{ form.stock|add_class:"input input-bordered w-full" }}
                
                    <ul>
                        {% for error in form.stock.errors %}
                        <li class="text-red-500 text-sm">{{ error }}</li>
                        {% endfor %}
                    </ul>
                </fieldset>
                
                <button type="submit" class="btn btn-primary w-full mb-4">Add Item</button>
                
                <a href="{% url 'shop:item_list' %}" class="btn btn-outline btn-secondary gap-2 w-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                    Back to Categories
                </a>
            </form>
        </div>

        <!-- Table Section -->
        <div class="flex-grow">
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body p-4 md:p-6">
                    <h1 class="text-xl md:text-2xl font-bold mb-4">Items List</h1>
                    
                    <!-- Scrollable Container -->
                    <div class="border border-gray-200 rounded-lg bg-base-100">
                        <div class="overflow-x-auto">
                            <table class="table table-zebra w-full">
                                <thead>
                                    <tr class="bg-base-200">
                                        <th class="bg-base-200">SN</th>
                                        <th class="bg-base-200">Item Name</th>
                                        <th class="bg-base-200">Amount</th>
                                        <th class="bg-base-200">Stock</th>
                                        <th class="bg-base-200">Barcode</th>
                                        <th class="bg-base-200">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="price-list">
                                    {% for price in prices %}
                                    <tr id="price-{{price.id}}">
                                        <th>{{ forloop.counter }}</th>
                                        <td class="font-medium">{{ price.name }}</td>
                                        <td>Rs {{ price.amount }}</td>
                                        <td>{{ price.stock }}</td>
                                        <td>
                                            <span class="font-mono text-xs bg-base-200 px-2 py-1 rounded border border-base-300">
                                                {{ price.barcode }}
                                            </span>
                                        </td>
                                        <td>
                                            <div class="flex gap-1 flex-wrap">
                                                <a href="{% url 'shop:price_update' price.id %}" 
                                                   class="btn btn-xs btn-primary whitespace-nowrap">Update</a>
                                                <button data-price-id="{{price.id}}" 
                                                        class="btn btn-xs btn-error whitespace-nowrap"
                                                        onclick="delete_price(this)">Delete</button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Empty State -->
                    {% if not prices %}
                    <div class="text-center py-12 text-gray-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-3 opacity-40" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
                        </svg>
                        <p class="text-lg font-medium">No items yet</p>
                        <p class="text-sm mt-1">Add your first item using the form on the left!</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</main>
<script>
    function remove_price_from_table(price_id) {
        const row_id_to_be_deleted = `price-${price_id}`;
        const row_to_be_deleted = document.getElementById(row_id_to_be_deleted);
        if (row_to_be_deleted) {
            row_to_be_deleted.remove();
            
            // Check if table is now empty and show empty state
            const table_body = document.getElementById("price-list");
            if (table_body.children.length === 0) {
                show_empty_state();
            }
        }
    }

    function show_empty_state() {
        const cardBody = document.querySelector('.card-body');
        const existingEmptyState = cardBody.querySelector('.text-center.py-12');
        
        if (!existingEmptyState) {
            const emptyStateHTML = `
                <div class="text-center py-12 text-gray-500">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-3 opacity-40" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
                    </svg>
                    <p class="text-lg font-medium">No items yet</p>
                    <p class="text-sm mt-1">Add your first item using the form on the left!</p>
                </div>
            `;
            cardBody.insertAdjacentHTML('beforeend', emptyStateHTML);
        }
    }

    function delete_price(btnElement) {
        const price_id = btnElement.dataset.priceId;

        fetch("{% url 'shop:price_delete' 'dummy' %}".replace('dummy', price_id))
            .then((response) => response.json())
            .then((data) => {
                if (data.success) {
                    show_toast_message(data.message, true);
                    remove_price_from_table(price_id);
                } else {
                    show_toast_message("Error: " + data.message, false);
                }
            })
            .catch((err) => console.error(err));
    }

    function show_toast_message(message, success = true) {
        const mainDiv = document.getElementById("main");
        const toastDiv = document.getElementById("toast-message");

        toastDiv?.remove();

        mainDiv.insertAdjacentHTML(
            "afterbegin",
            `<div class="toast toast-end toast-top z-50" id="toast-message">
                <div class="alert alert-${success ? 'success' : 'error'} shadow-lg">
                    <span class="font-semibold">${message}</span>
                </div>
            </div>`
        );

        // Auto-remove after 5 seconds
        setTimeout(() => {
            const currentToast = document.getElementById("toast-message");
            if (currentToast) {
                currentToast.remove();
            }
        }, 5000);
    }

    function add_price_to_table(price) {
        const table_body = document.getElementById("price-list");
        const rows_count = table_body.children.length;

        // Remove "No items yet" message if it exists
        const emptyState = table_body.closest('.card-body').querySelector('.text-center.py-12');
        if (emptyState) {
            emptyState.remove();
        }

        const update_url_template = "{% url 'shop:price_update' 'dummy' %}";
        const update_url = update_url_template.replace('dummy', price.id);

        const table_row = document.createElement("tr");
        table_row.id = `price-${price.id}`;

        table_row.innerHTML = `
            <th>${rows_count + 1}</th>
            <td class="font-medium">${price.name}</td>
            <td>Rs ${price.amount}</td>
            <td>${price.stock}</td>
            <td>
                <span class="font-mono text-xs bg-base-200 px-2 py-1 rounded border border-base-300">
                    ${price.barcode}
                </span>
            </td>
            <td>
                <div class="flex gap-1 flex-wrap">
                    <a href="${update_url}" class="btn btn-xs btn-primary whitespace-nowrap">Update</a>
                    <button data-price-id="${price.id}" class="btn btn-xs btn-error whitespace-nowrap" onclick="delete_price(this)">Delete</button>
                </div>
            </td>
        `;

        table_body.appendChild(table_row);
    }

    document.getElementById("add-price-form").addEventListener("submit", function (e) {
        e.preventDefault();

        const formData = new FormData(this);
        const csrf_token = document.getElementsByName("csrfmiddlewaretoken")[0].value;
        
        fetch("{% url 'shop:price' %}", {
            method: "POST",
            headers: { "X-CSRFToken": csrf_token },
            body: formData,
        })
        .then((response) => response.json())
        .then((data) => {
            if (data.success) {
                show_toast_message(data.message, true);
                add_price_to_table(data.data);
            } else {
                show_toast_message("Error: " + data.message, false);
            }
        })
        .catch((err) => console.error(err));
    });

    // Auto-hide Django messages after 5 seconds
    document.addEventListener('DOMContentLoaded', function() {
        const toastContainer = document.getElementById('toast-container');
        if (toastContainer && toastContainer.children.length > 0) {
            setTimeout(() => {
                toastContainer.innerHTML = '';
            }, 5000);
        }
    });
</script>

{% endblock content %}