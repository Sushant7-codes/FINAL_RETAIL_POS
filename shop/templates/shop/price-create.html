{% extends 'base.html' %}
{% load form_extras %}


{% block title %}
Price
{% endblock title %}

{% block content %}

<main class=" min-h-screen flex flex-col  gap-5 p-6 w-full mt-17" id="main">

    <div class="toast toast-end toast-top">
    {% for message in messages %}
    {% if message.level == DEFAULT_MESSAGE_LEVELS.ERROR %}
    <div class="alert alert-error alert-soft">
        {% else %}
        <div class="alert alert-success alert-soft">
            {% endif %}
            <span>{{message}}</span>
        </div>
        {% endfor %}
    </div>
    
    <h1 class="text-3xl font-bold mb-4">Add Item ({{item.name}})</h1>
    <div class="flex  gap-12">
        <form id="add-price-form" action="" method="post" class="flex-grow max-w-[500px]">
            {% csrf_token %}
            <input type="hidden" name="item_id" value="{{item.id}}">
            <fieldset class="fieldset mb-1">
                <label class="label text-xl" for="{{ form.name.id_for_label }}">Item {{form.name.label}}</label>
                {{ form.name|add_class:"input p-3 mb-1 min-w-[300px] w-full" }}

                <ul>
                    {% for error in form.name.errors %}
                    <li class="text-red-500 text-sm">{{ error }}</li>
                    {% endfor %}
                </ul>

            </fieldset>
            <fieldset class="fieldset mb-1">
                <label class="label text-xl" for="{{ form.amount.id_for_label }}">{{form.amount.label}}</label>
                {{ form.amount|add_class:"input p-3 mb-1 min-w-[300px] w-full" }}

                <ul>
                    {% for error in form.amount.errors %}
                    <li class="text-red-500 text-sm">{{ error }}</li>
                    {% endfor %}
                </ul>
            </fieldset> 

            <!-- Add this fieldset after the amount field -->
            <fieldset class="fieldset mb-1">
                <label class="label text-xl" for="{{ form.stock.id_for_label }}">{{ form.stock.label }}</label>
                {{ form.stock|add_class:"input p-3 mb-1 min-w-[300px] w-full" }}
            
                <ul>
                    {% for error in form.stock.errors %}
                    <li class="text-red-500 text-sm">{{ error }}</li>
                    {% endfor %}
                </ul>
            </fieldset>
            <button type="submit" class="btn btn-primary">Add Item</button><br><br><br>
            <!-- Add this after the table div -->
            <a href="{% url 'shop:item_list' %}" class="btn btn-outline btn-secondary gap-2 mt-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
                Go back to category
            </a><br>
        </form>

        



        <div class="flex-grow">
            <h1 class="text-2xl font-bold mb-4">Items List</h1>
            <div class="overflow-x-auto rounded-box border border-base-content/5 bg-base-100">
                <table class="table">
                    <!-- head -->
                    <thead>
                        <tr>
                            <th>SN</th>
                            <th>Item Name</th>
                            <th>Amount</th>
                            <th>Stock</th>
                            <th>Actions</th>
                            
                        </tr>
                    </thead>
                    <tbody id="price-list">

                        {% for price in prices %}
                            <tr id="price-{{price.id}}">
                                <th>{{ forloop.counter }}</th>
                                <td>{{ price.name }}</td>
                                <td>{{ price.amount }}</td>
                                <td>{{ price.stock }}</td>
                                <td>
                                    <div class="flex gap-2">
                                        
                                        <a href="{% url 'shop:price_update' price.id %}"
                                            class="btn btn-sm btn-primary">Update</a>
                                        
                                        <button data-price-id="{{price.id}}" class="btn btn-sm btn-error"
                                            onclick="delete_price(this)">Delete</button>

                                        
                                    </div>

                                </td>
                            </tr>

                            {% endfor %}
                    </tbody>
                </table>
            </div>

        </div>

        
    </div>
</main>

<script>

    function remove_price_from_table(price_id) {
        const row_id_to_be_deleted=`price-${price_id}`
        const row_to_be_deleted = document.getElementById(row_id_to_be_deleted)
        row_to_be_deleted.remove()

    }

    function delete_price(btnElement) {
        const price_id = btnElement.dataset.priceId;

        fetch("{% url 'shop:price_delete' 'dummy' %}".replace('dummy',price_id))
            .then((response) => response.json())
            .then((data) => {
                if (data.success) {
                    show_toast_message(data.message,success=true)
                    remove_price_from_table(price_id)
                } else {
                     show_toast_message("Error: " + data.message,success=false)
                }
            })
            .catch((err) => console.error(err));
    }

    function show_toast_message(message,success=true) {
        const mainDiv=document.getElementById("main")
        const toastDiv = document.getElementById("toast-message")

        toastDiv?.remove()

        mainDiv.insertAdjacentHTML(
            "afterbegin",`
            <div class="toast toast-end toast-top z-50" id="toast-message">
                <div class="alert alert-${success===true?'success':'error'} shadow-lg">
                    <span class="font-semibold">${message}</span>
                </div>
            </div>
            `
        )
    }

function add_price_to_table(price) {
    const table_body = document.getElementById("price-list");
    const rows_count = table_body.children.length;

    // Create a dummy URL for update link dynamically using Django URL pattern
    const update_url_template = "{% url 'shop:price_update' 'dummy' %}";
    const update_url = update_url_template.replace('dummy', price.id);

    const table_row = document.createElement("tr");
    table_row.id = `price-${price.id}`;

    table_row.innerHTML = `
        <th>${rows_count + 1}</th>
        <td>${price.name}</td>
        <td>${price.amount}</td>
        <td>${price.stock}</td>
        <td>
            <div class="flex gap-2">
                <a href="${update_url}" class="btn btn-sm btn-primary">Update</a>
                <button data-price-id="${price.id}" class="btn btn-sm btn-error" onclick="delete_price(this)">Delete</button>
            </div>
        </td>
    `;

    table_body.appendChild(table_row);
}


    document
        .getElementById("add-price-form")
        .addEventListener("submit", function (e) {
            e.preventDefault(); // Prevent the form from submitting normally, which would cause a page reload

            const formData = new FormData(this); // this means, current target html element,which is in this case is our add-price-form

            const csrf_token = document.getElementsByName("csrfmiddlewaretoken")[0].value;
            // const item_id = document.getElementsByName("item_id")[0].value;
            
            fetch("{% url 'shop:price' %}", {
                method: "POST",
                headers: { "X-CSRFToken": csrf_token },
                body: formData,
            })
                .then((response) => response.json())
                .then((data) => {
                    if (data.success) {
                        show_toast_message(data.message,success=true)
                        add_price_to_table(data.data);
                    } else {
                        show_toast_message("Error: " + data.message,success=false)
                    }
                })
                .catch((err) => console.error(err));
        });

</script>

{% endblock content %}